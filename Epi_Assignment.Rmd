---
title: "Epi practice"
author: "Siyu Zou"
date: "2024-04-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readr)
# install.packages("survey")
library(survey)
library(sandwich)
library(ggplot2)
```

```{r}
data <- read.csv("/Users/zousiyu/Library/CloudStorage/OneDrive-JohnsHopkins/Term 4/Epi/Lecture2/Module1/Assignment1/NHIS 2022 Adult Data.csv")
```


```{r}
survey_data <- svydesign(id=~ppsu, strata=~pstrat, weights=~wtfa_a, data=data , nest=TRUE)

```

A. Proportions/Means
Q1-Q4
```{r}
table(data$hypertension)
17452/(17452+10152)
10152/(17452+10152)

svymean(~factor(hypertension),design=survey_data,na.rm=TRUE,deff=TRUE)
```

Q5-Q6
```{r}
svyby(~factor(partner),~factor(hypertension),FUN=svymean,design=survey_data, ci=TRUE, deff=TRUE,na.rm=TRUE)

#Toget the Rao-Scott corrected chi-square statistic:
 # svychisq(~factor(hypertension)+factor(partner), design=survey_data, na.rm=TRUE, statistic="F")
```

Q7-Q8
0=Female
1=Male
```{r}
# Step 1: Subset the data for males reporting ever having had hypertension
male_hypertension_data <- subset(survey_data, sex == 1 & hypertension == 1)

# Step 2: Calculate the weighted mean age and its standard error for this subgroup
svymean(~agep_a, design=male_hypertension_data, na.rm=TRUE,deff=TRUE)

```

Question 9-10: (6 points)
Using weighted data, visually depict the proportions of individuals reporting having a high school education or less vs. at least some college education within groups of those reporting having Normal Blood Pressure vs. Hypertension.

maxed: 0=High School graduate or less 1=Any college or more
```{r}
svyby(~factor(maxed),~factor(hypertension),FUN=svymean,design=survey_data, ci=TRUE, deff=TRUE,na.rm=TRUE)

obj<-svyby(~factor(maxed),
           by=~factor(hypertension),
           FUN=svymean,design=survey_data, 
           ci=TRUE, deff=TRUE,na.rm=TRUE)


# barplot(obj,
#         legend.text=TRUE,
#         axisnames = TRUE,
#         names.arg = c('No Hypertension', 'Hypertension')) 

barplot(obj, 
        axisnames = TRUE,
        names.arg = c('Normal Blood Pressure',
                      'Hypertension'),
        legend.text = c('High School education or less',
                        'At Least Some College'),
        legend.position = c(x = 3.5, y = 1), 
        ylim = c(0,1))

### change color 
barplot(obj, 
        axisnames = TRUE,
        names.arg = c('Normal Blood Pressure', 'Hypertension'),
        ylim = c(0,1.0),
        col = c("lightgreen", "pink"))

# Adding the legend separately with positioning
legend(x = 3.3, y = 1, # Position of the legend
       legend = c('High School education or less', 'At Least Some College'),
       fill = c("lightgreen", "pink"))

```

```{r}
fit <- svyglm( factor(hypertension)~ factor(partner) + factor(maxed) + factor(sex) + factor(region), design=survey_data, family=quasibinomial(link="logit"))

exp(coef(fit))
exp(confint(fit))
summary(fit)
```


```{r}
fit2 <- glm(  factor(hypertension) ~ factor(partner) + factor(maxed) + 
    factor(sex) + factor(region), data = data, family=binomial(link = "logit"))
summary(fit2)
exp(coef(fit2))
```

